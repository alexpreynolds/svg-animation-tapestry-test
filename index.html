<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="UTF-8">
        <title>Altius Insitute for Biomedical Sciences</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="assets/css/styles.css" media="screen">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
        <!-- cf. http://www.favicomatic.com -->
        <link rel="apple-touch-icon-precomposed" sizes="57x57" href="assets/favico/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/favico/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/favico/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/favico/apple-touch-icon-144x144.png" />
        <link rel="apple-touch-icon-precomposed" sizes="60x60" href="assets/favico/apple-touch-icon-60x60.png" />
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="assets/favico/apple-touch-icon-120x120.png" />
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="assets/favico/apple-touch-icon-76x76.png" />
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="assets/favico/apple-touch-icon-152x152.png" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-196x196.png" sizes="196x196" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-16x16.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="assets/favico/favicon-128.png" sizes="128x128" />
        <meta name="application-name" content="&nbsp;"/>
        <meta name="msapplication-TileColor" content="#FFFFFF" />
        <meta name="msapplication-TileImage" content="assets/favico/mstile-144x144.png" />
        <meta name="msapplication-square70x70logo" content="assets/favico/mstile-70x70.png" />
        <meta name="msapplication-square150x150logo" content="assets/favico/mstile-150x150.png" />
        <meta name="msapplication-wide310x150logo" content="assets/favico/mstile-310x150.png" />
        <meta name="msapplication-square310x310logo" content="assets/favico/mstile-310x310.png" />
    </head>
    <body>
        <div id="parent_container">
            <div id="svg_container">
                <div id="node_layers_container"></div>
                <div id="wordmark_container"></div>
            </div>
            <div id="content" style="opacity:0;">
                <div class="main">
                    <p>Developing revolutionary technologies to empower breakthrough science</p>
                    <p>Creating a new scientific environment that radically enables exceptionally talented individuals to do the best work of their lives</p>
                </div>
                <div class="contact">
                    <p>
                        Inquiries: <a href="mailto:info@altiusinstitute.org">info@altiusinstitute.org</a><br>
                        2211 Elliott Ave, Suite 600, Seattle WA 98121
                    </p>
                </div>
            </div>
            <div id="background"><img src="assets/img/background.jpg" alt="Altius Institute for Biomedical Sciences" id="logo_background" class="logo_background" /></div>
        </div>
        
        <!-- cf. https://github.com/petkaantonov/deque -->
        <script type="text/javascript" src="assets/js/deque.min.js"></script>
        <script type="text/javascript" src="assets/js/guid.min.js"></script>

        <!-- external frameworks -->
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
        <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
        <script type="text/javascript" src="https://d3js.org/d3-interpolate.v1.min.js"></script>
        
        <!-- my code -->
        <script type="text/javascript">

            const WORDMARK_SCALE = 1.85; // a higher value makes a smaller wordmark
            const WORDMARK_EASE_FN = "cubic";
            const WORDMARK_EASE_DURATION_MS = 750;
            const WORDMARK_FINAL_OPACITY = 1;
            const NODE_LAYERS = 14;
            const NODE_LAYER_ROWS = 5;
            const NODE_LAYER_ID_PREFIX = "node_layer_";
            const NODE_LAYER_SCALE = 0.9;
            const NODE_LAYER_SLOWDOWN_FACTOR = 8;
            const NODE_ROW_SQUEEZE_FACTOR = 1.2;
            const NODE_COL_SQUEEZE_FACTOR = 0.3;
            const NODE_LAYERS_EASE_FN = "cubic";
            const NODE_LAYERS_EASE_DURATION_MS = 1500;
            const NODE_LAYERS_FINAL_OPACITY = 1;
            const SVG_ASSET_ROOT = "assets/components/";
            const CONTENT_EASE_FN = "cubic";
            const CONTENT_EASE_DURATION_MS = 750;
            const CONTENT_FINAL_OPACITY = 1;
            const TIME_ZERO = Date.now();

            var logo_background_img = document.getElementById('logo_background');
            var logo_background = { offset : null, width : 0, height : 0, centerX : 0, centerY : 0 };

            var node_layers_xml = null;
            var node_layers_deque = new Deque();
            var node_layers_ids = [];
            var node_layers_animating = new Deque();
            var node_layers_visible = false;
            var node_layer_margin = { top : 0, right : 0, bottom : 0, left : 0 };
            var node_layers = { max_height : 0, max_width : 0, rows : 0, cols : 0 };
            var node_layer_rotation_degrees = 0;

            var svg_parent = document.getElementById('svg_container');
            var wordmark_parent = document.getElementById('wordmark_container');
            var node_layers_parent = document.getElementById('node_layers_container');

            var update_logo_background_state = function() {
                var $this = $('#logo_background');
                logo_background.offset = $this.offset();
                logo_background.width = $this.width();
                logo_background.height = $this.height();
                logo_background.centerX = logo_background.offset.left + logo_background.width / 2;
                logo_background.centerY = logo_background.offset.top + logo_background.height / 2;
            };

            var position_content = function() {
                $('#content').css("padding-top", num_as_px(logo_background.height));
                if ($('#content').css("opacity") == 0) {
                    d3.select('#content').transition().ease(CONTENT_EASE_FN).duration(CONTENT_EASE_DURATION_MS).style('opacity', CONTENT_FINAL_OPACITY);
                }
            };

            var trigger_window_resize = function() {
                window.dispatchEvent(new Event('resize'));
            }

            var logo_background_img_loaded = function() {
                trigger_window_resize();
            }

            var load_wordmark = function(cb) {
                var wordmark_path = SVG_ASSET_ROOT + "wordmark.svg";
                d3.xml(wordmark_path, "image/svg+xml", function(error, xml) {
                    if (error) throw error;
                    update_logo_background_state();
                    xml.documentElement.setAttribute("preserveAspectRatio", "xMidYMid meet");
                    xml.documentElement.setAttribute("class", "svg_content");
                    xml.documentElement.style.width = num_as_px(0);
                    xml.documentElement.style.top = num_as_px(-1000);
                    xml.documentElement.style.left = num_as_px(-1000);
                    xml.documentElement.style.opacity = 0;
                    wordmark_parent.appendChild(xml.documentElement);
                    if (cb) cb();
                });
            };

            var position_wordmark = function() {
                update_logo_background_state();
                var wordmark = d3.select("#wordmark");
                wordmark.style("width", num_as_px(logo_background.width / WORDMARK_SCALE))
                    .style("top", num_as_px(logo_background.centerY - parseInt($('#wordmark').height()) / 2 - parseInt($('#parent_container').css("margin-top"))))
                    .style("left", num_as_px(logo_background.centerX - parseInt($('#wordmark').width()) / 2))
                if (wordmark.style("opacity") == 0) {
                    wordmark.transition().ease(WORDMARK_EASE_FN).duration(WORDMARK_EASE_DURATION_MS).style('opacity', WORDMARK_FINAL_OPACITY);
                }
            };

            var load_node_layers = function(cb) {
                var node_layers_path = SVG_ASSET_ROOT + "nodes.svg";
                d3.xml(node_layers_path, "image/svg+xml", function(error, xml) {
                    if (error) throw error;
                    xml.documentElement.style.width = num_as_px(0);
                    xml.documentElement.style.top = num_as_px(-1000);
                    xml.documentElement.style.left = num_as_px(-1000);
                    node_layers_xml = xml;
                    node_layers_parent.appendChild(xml.documentElement);
                    if (cb) cb();
                });
            };

            var update_node_layers_state = function() {
                update_logo_background_state();
                node_layers.max_height = (logo_background.height - (NODE_LAYER_ROWS * (node_layer_margin.top + node_layer_margin.bottom))) / NODE_LAYER_ROWS;
                node_layers.max_width = node_layers.max_height;
                node_layers.rows = NODE_LAYER_ROWS;
                node_layers.cols = (1 / NODE_COL_SQUEEZE_FACTOR) * Math.ceil(logo_background.width / node_layers.max_width);
            };

            var init_node_layers = function(cb) {
                update_node_layers_state();
                $('#node_layers_container').height(logo_background.height);
                $('#node_layers_container').css("opacity", 0);
                /* node layers are added by row */
                var test_id = null;
                for (var row_idx = 0; row_idx < node_layers.rows; row_idx++) {
                    var node_layer_row = [];
                    for (var col_idx = 0; col_idx < node_layers.cols; col_idx++) {
                        var random_svg_node_layer_id = random_svg_node_layer_obj().id;
                        var col_shift = (col_idx % 2) ? 0 : node_layers.max_height / 2;
                        var row_shift = node_layers.max_width / 2;
                        // build a data model for the offset and size of each node layer
                        var node_layer_obj = {};
                        node_layer_obj['id'] = 'node-layer-' + Math.guid(); // CSS selectors cannot start with digits cf. http://www.w3.org/TR/CSS21/syndata.html#value-def-identifier
                        node_layer_obj['static'] = true;
                        node_layer_obj['initial_random_rotation'] = Math.floor(Math.random() * 360);
                        node_layer_obj['top'] = (row_idx * (node_layers.max_height + node_layer_margin.top + node_layer_margin.bottom) - col_shift) * NODE_ROW_SQUEEZE_FACTOR;
                        node_layer_obj['left'] = col_idx * NODE_COL_SQUEEZE_FACTOR * (node_layers.max_width + node_layer_margin.left + node_layer_margin.right) - row_shift;
                        node_layer_obj['width'] = NODE_LAYER_SCALE * node_layers.max_width + node_layer_margin.left + node_layer_margin.right;
                        node_layer_obj['height'] = NODE_LAYER_SCALE * node_layers.max_height + node_layer_margin.top + node_layer_margin.bottom;
                        node_layer_row.push(node_layer_obj);
                        // render UI element from data model
                        var layer_id = node_layer_obj['id'];
                        var layer_classes = "node_layer_container nlrow_" + row_idx + " nlcol_" + col_idx;
                        if (row_idx == 1 && col_idx == 2) test_id = layer_id;
                        d3.select("#node_layers_container")
                            .append("svg")
                            .attr("id", layer_id)
                            .attr("class", layer_classes)
                            .attr("width", node_layer_obj['width'])
                            .attr("height", node_layer_obj['height'])
                            .attr("viewBox", "0 0 216 216")
                            .append("g")
                            .attr("class", "node_layer_transform")
                            .attr("transform", "translate(" + node_layer_margin.left + "," + node_layer_margin.top + ")")
                            .append("use")
                            .attr("class", "random_node_layer" + (col_idx % 2 ? " random_node_layer_even" : " random_node_layer_odd"))
                            .attr("xlink:href", "#" + random_svg_node_layer_id);
                        $('#' + layer_id).css("top", num_as_px(node_layer_obj['top']));
                        $('#' + layer_id).css("left", num_as_px(node_layer_obj['left']));
                        node_layers_ids.push(layer_id);
                    }
                    node_layers_deque.push(node_layer_row);
                }
                d3.select('#node_layers_container').transition().ease(NODE_LAYERS_EASE_FN).duration(NODE_LAYERS_EASE_DURATION_MS).style('opacity', NODE_LAYERS_FINAL_OPACITY).each("end", function() { 
                    node_layers_visible = true; 
                    cb();
                });
            };

            var position_node_layers = function(cb) {
                //console.log(node_layers_deque);
                update_node_layers_state();
                $('#node_layers_container').height(logo_background.height);
                $('#svg_container').css("max-height", num_as_px(logo_background.height));
                for (var row_idx = 0; row_idx < node_layers.rows; row_idx++) {
                    var node_layer_row = node_layers_deque.get(row_idx);
                    for (var col_idx = 0; col_idx < node_layers.cols; col_idx++) {
                        var node_layer_obj = node_layer_row[col_idx];
                        var layer_id = node_layer_obj['id'];
                        var col_shift = (col_idx % 2) ? 0 : node_layers.max_height / 2;
                        var row_shift = node_layers.max_width / 2;
                        /* update per-node layer model */
                        node_layer_obj['top'] = (row_idx * (node_layers.max_height + node_layer_margin.top + node_layer_margin.bottom) - col_shift) * NODE_ROW_SQUEEZE_FACTOR;
                        node_layer_obj['left'] = col_idx * NODE_COL_SQUEEZE_FACTOR * (node_layers.max_width + node_layer_margin.left + node_layer_margin.right) - row_shift;
                        node_layer_obj['width'] = NODE_LAYER_SCALE * node_layers.max_width + node_layer_margin.left + node_layer_margin.right;
                        node_layer_obj['height'] = NODE_LAYER_SCALE * node_layers.max_height + node_layer_margin.top + node_layer_margin.bottom;
                        /* update UI */
                        $('#' + layer_id).css("width", num_as_px(node_layer_obj['width']));
                        $('#' + layer_id).css("height", num_as_px(node_layer_obj['height']));
                        $('#' + layer_id).css("top", num_as_px(node_layer_obj['top']));
                        $('#' + layer_id).css("left", num_as_px(node_layer_obj['left']));
                    }
                }
                if (cb) cb();
            };

            var animate_random_node_layers = function(n) {
                if (node_layers_visible) {
                    update_node_layers_state();
                    for (var node_idx = 0; node_idx < n; node_idx++) {
                        var random_node_layer_id = node_layers_ids[Math.floor(Math.random() * node_layers_ids.length)];
                        node_layers_animating.push(random_node_layer_id);
                    }
                    for (var row_idx = 0; row_idx < node_layers.rows; row_idx++) {
                        var node_layer_row = node_layers_deque.get(row_idx);
                        for (var col_idx = 0; col_idx < node_layers.cols; col_idx++) {
                            var node_layer_obj = node_layer_row[col_idx];
                            var layer_id = node_layer_obj['id'];
                            if (node_layers_animating.toArray().indexOf(layer_id) != -1) {
                                node_layer_obj['static'] = false;
                                d3.select("#" + layer_id)
                                    .selectAll('.node_layer_transform')
                                    .attr("class", "node_layer_transform rotating")
                                    .attr("initial_random_rotation", node_layer_obj['initial_random_rotation']);
                            }
                        }
                    }
                }
            };

            var update_node_layer_rotation = function() {
                if (node_layers_visible) {
                    var rotating_node_layers = d3.selectAll('.node_layer_transform.rotating').attr("transform", function(d) { return "rotate(" + node_layer_rotation_degrees + ",114,110)"; });
                }
            };

            var num_as_px = function(i) {
                return parseFloat(i) + "px";
            };

            var random_svg_node_layer_obj = function() {
                var idx = Math.ceil(Math.random() * NODE_LAYERS);
                return { 'id' : NODE_LAYER_ID_PREFIX + idx, 'idx' : idx }; 
            };

            window.addEventListener("load", function() {
                load_wordmark(function() { 
                    trigger_window_resize(); 
                });
                load_node_layers(function() { 
                    trigger_window_resize();
                    init_node_layers( function() { animate_random_node_layers(25); } );
                });
                if (logo_background_img.complete) {
                    logo_background_img_loaded();
                } else {
                    logo_background_img.addEventListener('load', logo_background_img_loaded);
                }
                d3.timer(function() {
                    var delta = (Date.now() - TIME_ZERO);
                    node_layer_rotation_degrees = (delta / NODE_LAYER_SLOWDOWN_FACTOR) % 360;
                    update_node_layer_rotation();
                    //return (delta > 10000);
                    return false;
                });
            });

            window.addEventListener("resize", function() {
                if (this.resize_window_timer)
                    clearTimeout(this.resize_window_timer);
                this.resize_window_timer = setTimeout(function() { 
                    position_wordmark();
                    position_content();
                    position_node_layers();
                }, 200);
            });

        </script>
    </body>
    
</html>
